name: Publish Facets Modules

on:
  pull_request:
    branches:
      - main
    types:
      - closed

env:
  FACETS_USERNAME: samarthya@facets.cloud
  FACETS_TOKEN: ${{ secrets.FACETS_API_TOKEN }}
  CONTROL_PLANE_URL: https://facetsdemo.console.facets.cloud

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Raptor CLI
        run: |
          curl -LO https://github.com/Facets-cloud/raptor-releases/releases/latest/download/raptor-linux-amd64
          chmod +x raptor-linux-amd64
          sudo mv raptor-linux-amd64 /usr/local/bin/raptor

      - name: Verify Raptor installation
        run: |
          ls -la /usr/local/bin/raptor
          file /usr/local/bin/raptor

      - name: Verify Raptor auth
        run: raptor whoami

      - name: Detect changed modules
        id: changes
        run: |
          # For merged PRs, compare the merge commit with its first parent (the previous main)
          # This gives us all the files that were changed in the PR
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            BASE_REF="HEAD~1"
            COMPARE_REF="HEAD"
          else
            BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
            COMPARE_REF="HEAD"
          fi

          echo "Comparing $BASE_REF...$COMPARE_REF"

          CHANGED_MODULES=$(git diff --name-only $BASE_REF $COMPARE_REF | \
            grep -E '^[^/]+/[^/]+/[^/]+/' | \
            sed 's|\([^/]*/[^/]*/[^/]*\)/.*|\1|' | \
            sort -u | \
            while read dir; do
              if [ -f "$dir/facets.yaml" ]; then
                echo "$dir"
              fi
            done)

          if [ -z "$CHANGED_MODULES" ]; then
            echo "No module changes detected"
            echo "modules=" >> $GITHUB_OUTPUT
          else
            echo "Changed modules:"
            echo "$CHANGED_MODULES"
            MODULES_JSON=$(echo "$CHANGED_MODULES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "modules=$MODULES_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Upload changed modules (PREVIEW)
        if: steps.changes.outputs.modules != '' && steps.changes.outputs.modules != '[]'
        run: |
          MODULES='${{ steps.changes.outputs.modules }}'

          for MODULE_PATH in $(echo "$MODULES" | jq -r '.[]'); do
            echo "========================================"
            echo "Validating: $MODULE_PATH"
            echo "========================================"

            # Validate module first
            raptor create iac-module -f "$MODULE_PATH" --dry-run

            echo "========================================"
            echo "Uploading: $MODULE_PATH (PREVIEW)"
            echo "========================================"

            # Upload to PREVIEW stage (manual publish required)
            raptor create iac-module -f "$MODULE_PATH" --auto-create

            MODULE_ID=$(echo "$MODULE_PATH" | tr '/' ' ' | awk '{print $1"/"$2"/"$3}')
            echo "âœ“ Uploaded: $MODULE_ID (PREVIEW stage)"
            echo "  To publish manually: raptor publish iac-module $MODULE_ID"
          done
